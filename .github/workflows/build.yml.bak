name: Build Desktop Artifacts

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-linux-x64:
    name: Linux x64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build Linux x64
        run: bun run dist

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: duplex-linux-x64
          path: |
            dist/*.AppImage
            dist/*.AppImage.blockmap
            dist/latest-linux.yml
          if-no-files-found: error

  build-mac-arm64:
    name: macOS arm64
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Check Signing Credentials
        id: creds
        run: |
          if [[ -n "${{ secrets.APPLE_CERTIFICATE }}" && -n "${{ secrets.APPLE_API_KEY_CONTENT }}" && -n "${{ secrets.APPLE_API_KEY }}" && -n "${{ secrets.APPLE_API_ISSUER }}" ]]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Import Developer ID Certificate
        if: steps.creds.outputs.available == 'true'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Write App Store Connect API Key
        if: steps.creds.outputs.available == 'true'
        run: |
          api_key_path="$RUNNER_TEMP/AuthKey_${{ secrets.APPLE_API_KEY }}.p8"
          printf "%s" "${{ secrets.APPLE_API_KEY_CONTENT }}" > "$api_key_path"
          chmod 600 "$api_key_path"
          echo "APPLE_API_KEY=$api_key_path" >> "$GITHUB_ENV"

      - name: Build macOS arm64 (Signed + Notarized)
        if: steps.creds.outputs.available == 'true'
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
        run: bun run dist

      - name: Build macOS arm64 (Unsigned Fallback)
        if: steps.creds.outputs.available != 'true'
        run: |
          bun run build
          bunx electron-builder --mac dmg --arm64 -c.mac.identity=null -c.mac.notarize=false

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: duplex-mac-arm64
          path: |
            dist/*.dmg
            dist/*.dmg.blockmap
          if-no-files-found: error
